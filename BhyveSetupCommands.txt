# create new directory for the VM files.
doas mkdir -p vms/debian
# Download the newest Debian installation media .iso
doas fetch -o "$HOME/vms/debian/debian-installer.iso" https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-12.2.0-amd64-netinst.iso
# create a new dataset to serve as the VMs virtual storage
doas zfs create -sV 10G -o volmode=dev "zroot/debian-vm_disk0"
# alternative: doas truncate -s 10G "$HOME/vms/debian/debian_disk0.img"

# add the following to /etc/rc.conf
cloned_interfaces="bridge0 tap"
ifconfig_bridge0="addm igb1 addm tap0"

# enable tap interface and allow network traffic to cross bridge stack
doas sysctl net.link.tap.up_on_open=1
doas sysctl net.link.bridge.pfil_member=0

# add to /etc/pf.conf.d/bhf
pass in quick on bridge0
pass in quick proto tcp to port 5900
# add as well if doing the full lab: pass in quick proto tcp to port 48898

#tell the firewall to read the new rules
doas pfctl -f /etc/pf.conf.d/bhf
# should output nothing.

#copy boot variables to make sure the Gues OS boots properly
doas  cp /usr/local/share/uefi-firmware/BHYVE_BHF_UEFI_VARS.fd /usr/home/Administrator/vms/debian/EFI_VARS.fd
# call the bhyve shell script to install OS
doas sh debian-vm.sh run --install
# call bhyve shell script to only launch bhyve (after installation)
doas sh debian-vm.sh run
